#include "ros/ros.h"
#include "layla_sim/get.h"
#include "layla_sim/set.h"
#include <string>
#include <vector>

#include "json_util.hpp"
#include "string_util.hpp"
#include "jsoncpp/json.h"

//std::string test_db = R"({"robots":{"2016":{"auto":{"gen":{"active_experiment":"HelloWorld","authtest":"authtest","benchmark":"{\"poem\":\"The berries are nice today\"}","config":{"configs":[],"counter":1},"experiments":{"HelloWorld":{"code":[{"code":"// JavaScript code","name":"start","time":""}]}},"frontend_status":{"1473118999000":{"heartbeats":9,"videobeats":0},"1473119100000":{"heartbeats":1,"videobeats":0},"1473207429000":{"heartbeats":10,"videobeats":0}},"gui":[{"active":false,"height":138,"minimized":false,"title":"Configure","width":670,"x":0,"y":0,"z":1},{"active":false,"height":100,"minimized":true,"title":"Drive","width":200,"x":0,"y":0,"z":2},{"active":false,"height":100,"minimized":true,"title":"Sensors","width":510,"x":0,"y":0,"z":3},{"active":false,"height":100,"minimized":true,"title":"Charts","width":224,"x":0,"y":0,"z":4},{"active":false,"height":246,"minimized":true,"title":"Code","width":770,"x":0,"y":0,"z":5},{"active":false,"height":358,"minimized":true,"title":"Map","width":200,"x":0,"y":0,"z":6},{"active":false,"height":100,"minimized":true,"title":"Video","width":200,"x":0,"y":0,"z":7},{"active":false,"height":100,"minimized":true,"title":"UI","width":269,"x":0,"y":0,"z":8},{"active":false,"height":118,"minimized":true,"title":"Sound","width":233,"x":0,"y":0,"z":9},{"active":false,"height":138,"minimized":true,"title":"Chat","width":227,"x":0,"y":0,"z":10}],"options":["ultrasonic_sensor PP","wheel_encoder PPC","encoder P","neato SP","latency ","heartbeat ","bms ","analog P","pwm P","neopixel PC","servo P","create2 S","sabertooth2 S","sabertooth1 S","bts PPPP"],"run":{"options":["Squeak","eagle","bike horn"],"play":false,"sound":"eagle"},"sensors":{"heartbeats":0}}},"uaf":{"azure_layla":{"active_experiment":"HelloWorld","authtest":"authtest","chat":[{"handle":"Pilot","message":"Welcome to azure layla chat!","time":1470436480017},{"handle":"Caretaker","message":"sdfd","time":1472870525612},{"handle":"Pilot","message":"test","time":1472871940201},{"handle":"Caretaker","message":"f","time":1472871885347},{"handle":"Caretaker","message":"sfsdf","time":1472871886117},{"handle":"Caretaker","message":"sdfds","time":1472871886580},{"handle":"Caretaker","message":"fdsf","time":1472871887084},{"handle":"Caretaker","message":"fsdfds","time":1472871888758},{"handle":"Caretaker","message":"dfsdfsd","time":1472871887966},{"handle":"Caretaker","message":"fsdfsdfd","time":1472871890199},{"handle":"Caretaker","message":"sdfsdf","time":1472871889458},{"handle":"Caretaker","message":"dsfdsfd","time":1472871891042},{"handle":"Caretaker","message":"sdfsdfd","time":1472871891808},{"handle":"Caretaker","message":"sdfdsf","time":1472871892575},{"handle":"Caretaker","message":"sfdfsdf","time":1472871895558},{"handle":"Caretaker","message":"sdfsdf","time":1472871896760},{"handle":"Caretaker","message":"sdfsdfd","time":1472871897594},{"handle":"Caretaker","message":"ffsdfsd","time":1472871899785},{"handle":"Caretaker","message":"sadsa","time":1472872361784},{"handle":"Caretaker","message":"sss","time":1472873129461}],"config":{"configs":["bts(9,10,11,12);"],"counter":9},"experiments":{"HelloWorld":{"code":[{"code":"// JavaScript code\nlabel(djfsd)\nfds\nsfd\ns\nds\ns\n","name":"start","time":""}]},"No%20experiments%20found.":{"code":[{"code":"// JavaScript code\n","name":"start","time":""}]},"goofus":{"code":[{"code":"","name":"HelloWorld","time":0}]},"test":{"code":[{"code":"// JavaScript code\nlabel(\"In state\"+state)\ndelay(500)\nstate=blob","name":"groove","time":""},{"code":"// JavaScript code\nlabel(\"In state\"+state)\ndelay(500)\nstate=groove","name":"blob","time":""},{"code":"\n","name":"HelloWorld","time":""}]}},"frontendStatus":[{"heartbeats":1,"videobeats":0}],"frontend_status":{"1472871553000":{"heartbeats":56,"videobeats":97}},"gui":[{"active":false,"height":258,"minimized":false,"title":"Configure","width":663,"x":0,"y":10,"z":1},{"active":false,"height":522,"minimized":false,"title":"Sensors","width":630,"x":133,"y":78,"z":2},{"active":false,"height":617,"minimized":true,"title":"Code","width":867,"x":52,"y":108,"z":3},{"active":false,"height":719,"minimized":false,"title":"Map","width":670,"x":0,"y":0,"z":4},{"active":false,"height":100,"minimized":true,"title":"UI","width":265,"x":0,"y":318,"z":5},{"active":false,"height":118,"minimized":false,"title":"Sound","width":234,"x":3,"y":427,"z":6},{"active":false,"height":424,"minimized":false,"title":"Drive","width":640,"x":852,"y":228,"z":7},{"active":false,"height":428,"minimized":false,"title":"Video","width":635,"x":808,"y":83,"z":8},{"active":false,"height":761,"minimized":false,"title":"Charts","width":566,"x":684,"y":85,"z":9},{"active":true,"height":331,"minimized":false,"title":"Chat","width":445,"x":138,"y":171,"z":10}],"hah":"test","kinect":{"angle":-33.322476200403841,"flapping":false,"joints":{"head":{"screen_x":490,"screen_y":140,"x":291,"y":-128,"z":620},"left_elbow":{"screen_x":550,"screen_y":262,"x":397,"y":30,"z":624},"left_hand":null,"left_shoulder":{"screen_x":623,"screen_y":265,"x":547,"y":33,"z":651},"right_elbow":{"screen_x":306,"screen_y":281,"x":-23,"y":52,"z":658},"right_hand":null,"right_shoulder":{"screen_x":329,"screen_y":236,"x":17,"y":-5,"z":652}}},"options":["hallEffect_sensor P","neato SP","latency ","heartbeat ","bms ","analog P","pwm P","neopixel PC","servo P","create2 S","sabertooth2 S","sabertooth1 S","bts PPPP"],"pilot":{"cmd":{"arg":"","run":""},"power":{"L":0,"R":0},"time":0},"pilotHeartbeat":{"pilotHeartbeat":17},"run":{"options":["Squeak","bike horn"],"play":false,"sound":"Squeak"},"sensors":{"backend_battery":{"charging":false,"dischargingTime":"317.53 minutes","percent":"99.00%"},"heartbeats":99,"power":{"L":0,"R":0}}},"azure_layla2":{"active_experiment":"HelloWorld","authtest":"authtest","chat":[{"handle":"Caretaker","message":"sdf","time":1470342324628},{"handle":"Caretaker","message":"sdf","time":1470342426428},{"handle":"Caretaker","message":"sdf","time":1470342517139},{"handle":"Caretaker","message":"sdf","time":1470342517508},{"handle":"Caretaker","message":"sdf","time":1470342517752},{"handle":"Caretaker","message":"sdf","time":1470342517945},{"handle":"Caretaker","message":"sdf","time":1470342518127},{"handle":"Caretaker","message":"sdf","time":1470342518310},{"handle":"Caretaker","message":"sdf","time":1470342518526},{"handle":"Caretaker","message":"sdf","time":1470342518726},{"handle":"Caretaker","message":"123","time":1470342537370},{"handle":"Caretaker","message":"456","time":1470342539360},{"handle":"Pilot","message":"Welcome to azure layla chat!","time":1470436480017}],"config":{"configs":["pwm(13);","heartbeat();","bts(9,10,11,12);","bms();"],"counter":7},"experiments":{"HelloWorld":{"code":[{"code":"// JavaScript code\nlabel(djfsd)\nfds\nsfd\ns\nds\ns\n","name":"start","time":""}]},"No%20experiments%20found.":{"code":[{"code":"// JavaScript code\n","name":"start","time":""}]},"goofus":{"code":[{"code":"","name":"HelloWorld","time":0}]},"test":{"code":[{"code":"// JavaScript code\nlabel(\"In state\"+state)\ndelay(500)\nstate=blob","name":"groove","time":""},{"code":"// JavaScript code\nlabel(\"In state\"+state)\ndelay(500)\nstate=groove","name":"blob","time":""},{"code":"\n","name":"HelloWorld","time":""}]}},"frontendStatus":[{"heartbeats":1,"videobeats":0}],"frontend_status":{"1472843432000":{"heartbeats":161,"videobeats":62}},"gui":[{"active":false,"height":258,"minimized":false,"title":"Configure","width":663,"x":0,"y":10,"z":1},{"active":false,"height":395,"minimized":false,"title":"Drive","width":640,"x":0,"y":187,"z":2},{"active":false,"height":522,"minimized":false,"title":"Sensors","width":630,"x":182,"y":211,"z":3},{"active":false,"height":371,"minimized":true,"title":"Charts","width":868,"x":0,"y":264,"z":4},{"active":false,"height":617,"minimized":true,"title":"Code","width":867,"x":52,"y":108,"z":5},{"active":false,"height":719,"minimized":true,"title":"Map","width":670,"x":0,"y":0,"z":6},{"active":false,"height":100,"minimized":true,"title":"UI","width":265,"x":0,"y":318,"z":7},{"active":false,"height":118,"minimized":true,"title":"Sound","width":234,"x":244,"y":187,"z":8},{"active":false,"height":331,"minimized":true,"title":"Chat","width":445,"x":138,"y":171,"z":9},{"active":true,"height":428,"minimized":false,"title":"Video","width":635,"x":144,"y":102,"z":10}],"hah":"test","options":["ultrasonic_sensor PP","wheel_encoder PPC","encoder P","neato SP","latency ","heartbeat ","bms ","analog P","pwm P","neopixel PC","servo P","create2 S","sabertooth2 S","sabertooth1 S","bts PPPP"],"pilot":{"cmd":{"arg":"","run":""},"power":{"L":0,"R":0,"pwm":[]},"time":0},"pilotHeartbeat":{"pilotHeartbeat":17},"run":{"options":["Squeak","bike horn"],"play":false,"sound":""},"sensors":{"battery":{"charge":0,"state":0},"heartbeats":145,"power":{"L":0,"R":0,"pwm":[0]}}},"roomba":{"authtest":"authtest","chat":[{"handle":"Caretaker","message":"sdf","time":1470342547297},{"handle":"Caretaker","message":"sdf","time":1470342548651},{"handle":"Caretaker","message":"123","time":1470342549845},{"handle":"Pilot","message":"test","time":1470436490726}],"config":{"configs":["create2(X2);"],"counter":6},"frontendStatus":[{"heartbeats":76,"videobeats":0}],"frontend_status":{"1470436173000":{"heartbeats":7,"videobeats":0}},"gui":[{"active":false,"height":306,"minimized":true,"title":"Configure","width":653,"x":0,"y":154,"z":1},{"active":false,"height":414,"minimized":false,"title":"Drive","width":402,"x":0,"y":154,"z":2},{"active":false,"height":481,"minimized":false,"title":"Sensors","width":510,"x":388,"y":154,"z":3},{"active":false,"height":542,"minimized":true,"title":"Code","width":734,"x":423,"y":312,"z":4},{"active":false,"height":380,"minimized":false,"title":"Video","width":531,"x":562,"y":159,"z":5},{"active":false,"height":100,"minimized":true,"title":"UI","width":263,"x":0,"y":326,"z":6},{"active":false,"height":171,"minimized":false,"title":"Sound","width":396,"x":382,"y":246,"z":7},{"active":false,"height":403,"minimized":false,"title":"Map","width":518,"x":933,"y":163,"z":8},{"active":false,"height":534,"minimized":false,"title":"Charts","width":622,"x":166,"y":46,"z":9},{"active":true,"height":340,"minimized":false,"title":"Chat","width":440,"x":192,"y":114,"z":10}],"options":["ultrasonic_sensor PP","wheel_encoder PPC","encoder P","neato SP","latency ","heartbeat ","bms ","analog P","pwm P","neopixel PC","servo P","create2 S","sabertooth2 S","sabertooth1 S","bts PPPP"],"pilot":{"cmd":{"arg":"","run":""},"power":{"L":0,"R":0},"time":0},"run":{"options":["Squeak","bike horn"],"play":false,"sound":"Squeak"},"sensors":{"battery":{"charge":2132,"state":4,"temperature":35},"bumper":15,"buttons":0,"encoder":{"L":51161,"R":9006},"floor":[0,0,0,0],"heartbeats":247,"light":[0,0,0,3,0,0],"light_field":0,"location":{"angle":-131.84829060956409,"x":4.6854000247151211,"y":4.8372473422891833,"z":0},"mode":1,"power":{"L":100,"R":100}}},"shiny_layla":{"active_experiment":"HelloWorld","authtest":"authtest","chat":{"handle":"Pilot","message":"so a cobal, c++, and java programmer walk into a bar...","time":1467162770730},"config":{"configs":["bms();","bts(9,10,11,12);"],"counter":5},"experiments":{"HelloWorld":{"code":[{"code":"// JavaScript code\n","name":"start","time":""}]},"code":[{"code":"// JavaScript code\n","name":"start","time":""}],"test":{"code":[{"code":"// JavaScript code\n//test","name":"start","time":""}]},"test2":{"code":[{"code":"// JavaScript code\n//test2","name":"start","time":""}]}},"frontendStatus":[{"heartbeats":146,"videobeats":0}],"frontend_status":{"1470687813000":{"heartbeats":37,"videobeats":0},"1470687909000":{"heartbeats":7,"videobeats":0},"1470688099000":{"heartbeats":23,"videobeats":0}},"gui":[{"active":false,"height":322,"minimized":false,"title":"Configure","width":883,"x":168,"y":332,"z":1},{"active":false,"height":285,"minimized":false,"title":"Sensors","width":490,"x":280,"y":28,"z":2},{"active":false,"height":456,"minimized":false,"title":"Charts","width":344,"x":0,"y":6,"z":3},{"active":false,"height":390,"minimized":false,"title":"Code","width":511,"x":0,"y":0,"z":4},{"active":false,"height":445,"minimized":true,"title":"Map","width":448,"x":0,"y":0,"z":5},{"active":false,"height":290,"minimized":true,"title":"Video","width":452,"x":122,"y":51,"z":6},{"active":false,"height":100,"minimized":true,"title":"UI","width":269,"x":87,"y":268,"z":7},{"active":false,"height":118,"minimized":false,"title":"Sound","width":234,"x":63,"y":262,"z":8},{"active":false,"height":431,"minimized":true,"title":"Chat","width":389,"x":0,"y":0,"z":9},{"active":true,"height":420,"minimized":false,"title":"Drive","width":419,"x":201,"y":39,"z":10}],"options":["hallEffect_sensor P","neato SP","latency ","heartbeat ","bms ","analog P","pwm P","neopixel PC","servo P","create2 S","sabertooth2 S","sabertooth1 S","bts PPPP"],"pilot":{"cmd":{"arg":"","run":""},"power":{"L":0,"R":0},"time":0},"run":{"options":["Squeak","bike horn"],"play":false,"sound":""},"sensors":{"battery":{"charge":71,"state":16},"heartbeats":225,"power":{"L":0,"R":0}}},"stealth_layla":{"active_experiment":"HelloWorld","authtest":"authtest","chat":{"handle":"Pilot","message":"hello?","time":1467162686606},"config":{"configs":["bts(9,10,11,12);","bms();"],"counter":7},"experiments":{"HelloWorld":{"code":[{"code":"// JavaScript code\nvar ii=0;","name":"start","time":""}]}},"frontendStatus":[{"heartbeats":21,"videobeats":0}],"frontend_status":{"1471983040000":{"heartbeats":110,"videobeats":0},"1471992787000":{"heartbeats":86,"videobeats":0},"1471992976000":{"heartbeats":250,"videobeats":0},"1471999232000":{"heartbeats":8,"videobeats":0},"1472844376000":{"heartbeats":78,"videobeats":0},"1472846749000":{"heartbeats":4,"videobeats":0},"1472876983000":{"heartbeats":19,"videobeats":0}},"gui":[{"active":false,"height":230,"minimized":true,"title":"Configure","width":653,"x":50,"y":51,"z":1},{"active":false,"height":323,"minimized":false,"title":"Sensors","width":545,"x":817,"y":149,"z":2},{"active":false,"height":607,"minimized":false,"title":"Charts","width":511,"x":120,"y":15,"z":3},{"active":false,"height":398,"minimized":true,"title":"Code","width":770,"x":388,"y":122,"z":4},{"active":false,"height":719,"minimized":true,"title":"Map","width":670,"x":252,"y":33,"z":5},{"active":false,"height":575,"minimized":true,"title":"Video","width":665,"x":367,"y":0,"z":6},{"active":false,"height":101,"minimized":true,"title":"UI","width":264,"x":87,"y":207,"z":7},{"active":false,"height":289,"minimized":false,"title":"Sound","width":474,"x":36,"y":275,"z":8},{"active":false,"height":330,"minimized":true,"title":"Chat","width":426,"x":568,"y":152,"z":9},{"active":true,"height":386,"minimized":false,"title":"Drive","width":426,"x":73,"y":91,"z":10}],"kinect":{"angle":-31.921036209310547,"flapping":false,"joints":{"head":{"screen_x":329,"screen_y":159,"x":15,"y":-101,"z":612},"left_elbow":null,"left_hand":null,"left_shoulder":{"screen_x":482,"screen_y":295,"x":305,"y":76,"z":680},"right_elbow":{"screen_x":455,"screen_y":398,"x":214,"y":190,"z":575},"right_hand":{"screen_x":130,"screen_y":286,"x":-272,"y":44,"z":502},"right_shoulder":{"screen_x":454,"screen_y":291,"x":227,"y":65,"z":617}}},"options":["ultrasonic_sensor PP","wheel_encoder PPC","encoder P","neato SP","latency ","heartbeat ","bms ","analog P","pwm P","neopixel PC","servo P","create2 S","sabertooth2 S","sabertooth1 S","bts PPPP"],"pilot":{"cmd":{"arg":"","run":""},"power":{"L":0,"R":0},"time":0},"run":{"options":["Squeak","bike horn"],"play":false,"sound":"Squeak"},"sensors":{"backend_battery":{"charging":false,"dischargingTime":"289.00 minutes","percent":"93.00%"},"battery":{"charge":0,"state":0},"heartbeats":31,"power":{"L":0,"R":0}}},"test2":{"authtest":"","config":{"configs":[],"counter":1},"experiments":{"HelloWorld":{"code":[{"code":"// JavaScript code","name":"start","time":""}]}},"options":["ultrasonic_sensor PP","wheel_encoder PPC","encoder P","neato SP","latency ","heartbeat ","bms ","analog P","pwm P","neopixel PC","servo P","create2 S","sabertooth2 S","sabertooth1 S","bts PPPP"],"run":{"options":["Squeak","eagle","bike horn"],"play":false,"sound":"eagle"},"sensors":{"heartbeats":0}}}}}})";
std::string test_db_str = R"({"benchmarks":{"test":78},"robots":{"2016":{"auto":{"gen":{"active_experiment":"HelloWorld","authtest":"authtest","benchmark":"{\"poem\":\"The berries are nice today\"}","config":{"configs":[],"counter":1},"experiments":{"HelloWorld":{"code":[{"code":"// JavaScript code","name":"start","time":""}]}},"frontend_status":{"1473118999000":{"heartbeats":9,"videobeats":0},"1473119100000":{"heartbeats":1,"videobeats":0},"1473207429000":{"heartbeats":10,"videobeats":0}},"gui":[{"active":false,"height":138,"minimized":false,"title":"Configure","width":670,"x":0,"y":0,"z":1},{"active":false,"height":100,"minimized":true,"title":"Drive","width":200,"x":0,"y":0,"z":2},{"active":false,"height":100,"minimized":true,"title":"Sensors","width":510,"x":0,"y":0,"z":3},{"active":false,"height":100,"minimized":true,"title":"Charts","width":224,"x":0,"y":0,"z":4},{"active":false,"height":246,"minimized":true,"title":"Code","width":770,"x":0,"y":0,"z":5},{"active":false,"height":358,"minimized":true,"title":"Map","width":200,"x":0,"y":0,"z":6},{"active":false,"height":100,"minimized":true,"title":"Video","width":200,"x":0,"y":0,"z":7},{"active":false,"height":100,"minimized":true,"title":"UI","width":269,"x":0,"y":0,"z":8},{"active":false,"height":118,"minimized":true,"title":"Sound","width":233,"x":0,"y":0,"z":9},{"active":false,"height":138,"minimized":true,"title":"Chat","width":227,"x":0,"y":0,"z":10}],"options":["ultrasonic_sensor PP","wheel_encoder PPC","encoder P","neato SP","latency ","heartbeat ","bms ","analog P","pwm P","neopixel PC","servo P","create2 S","sabertooth2 S","sabertooth1 S","bts PPPP"],"run":{"options":["Squeak","eagle","bike horn"],"play":false,"sound":"eagle"},"sensors":{"heartbeats":0}}},"uaf":{"azure_layla":{"active_experiment":"HelloWorld","authtest":"authtest","chat":[{"handle":"Pilot","message":"Welcome to azure layla chat!","time":1470436480017},{"handle":"Caretaker","message":"sdfd","time":1472870525612},{"handle":"Pilot","message":"test","time":1472871940201},{"handle":"Caretaker","message":"f","time":1472871885347},{"handle":"Caretaker","message":"sfsdf","time":1472871886117},{"handle":"Caretaker","message":"sdfds","time":1472871886580},{"handle":"Caretaker","message":"fdsf","time":1472871887084},{"handle":"Caretaker","message":"fsdfds","time":1472871888758},{"handle":"Caretaker","message":"dfsdfsd","time":1472871887966},{"handle":"Caretaker","message":"fsdfsdfd","time":1472871890199},{"handle":"Caretaker","message":"sdfsdf","time":1472871889458},{"handle":"Caretaker","message":"dsfdsfd","time":1472871891042},{"handle":"Caretaker","message":"sdfsdfd","time":1472871891808},{"handle":"Caretaker","message":"sdfdsf","time":1472871892575},{"handle":"Caretaker","message":"sfdfsdf","time":1472871895558},{"handle":"Caretaker","message":"sdfsdf","time":1472871896760},{"handle":"Caretaker","message":"sdfsdfd","time":1472871897594},{"handle":"Caretaker","message":"ffsdfsd","time":1472871899785},{"handle":"Caretaker","message":"sadsa","time":1472872361784},{"handle":"Caretaker","message":"sss","time":1472873129461}],"config":{"configs":["bts(9,10,11,12);"],"counter":9},"experiments":{"HelloWorld":{"code":[{"code":"// JavaScript code\nlabel(djfsd)\nfds\nsfd\ns\nds\ns\n","name":"start","time":""}]},"No%20experiments%20found.":{"code":[{"code":"// JavaScript code\n","name":"start","time":""}]},"goofus":{"code":[{"code":"","name":"HelloWorld","time":0}]},"test":{"code":[{"code":"// JavaScript code\nlabel(\"In state\"+state)\ndelay(500)\nstate=blob","name":"groove","time":""},{"code":"// JavaScript code\nlabel(\"In state\"+state)\ndelay(500)\nstate=groove","name":"blob","time":""},{"code":"\n","name":"HelloWorld","time":""}]}},"frontendStatus":[{"heartbeats":1,"videobeats":0}],"frontend_status":{"1472871553000":{"heartbeats":56,"videobeats":97}},"gui":[{"active":false,"height":258,"minimized":false,"title":"Configure","width":663,"x":0,"y":10,"z":1},{"active":false,"height":522,"minimized":false,"title":"Sensors","width":630,"x":133,"y":78,"z":2},{"active":false,"height":617,"minimized":true,"title":"Code","width":867,"x":52,"y":108,"z":3},{"active":false,"height":719,"minimized":false,"title":"Map","width":670,"x":0,"y":0,"z":4},{"active":false,"height":100,"minimized":true,"title":"UI","width":265,"x":0,"y":318,"z":5},{"active":false,"height":118,"minimized":false,"title":"Sound","width":234,"x":3,"y":427,"z":6},{"active":false,"height":424,"minimized":false,"title":"Drive","width":640,"x":852,"y":228,"z":7},{"active":false,"height":428,"minimized":false,"title":"Video","width":635,"x":808,"y":83,"z":8},{"active":false,"height":761,"minimized":false,"title":"Charts","width":566,"x":684,"y":85,"z":9},{"active":true,"height":331,"minimized":false,"title":"Chat","width":445,"x":138,"y":171,"z":10}],"hah":"test","kinect":{"angle":-33.322476200403841,"flapping":false,"joints":{"head":{"screen_x":490,"screen_y":140,"x":291,"y":-128,"z":620},"left_elbow":{"screen_x":550,"screen_y":262,"x":397,"y":30,"z":624},"left_hand":null,"left_shoulder":{"screen_x":623,"screen_y":265,"x":547,"y":33,"z":651},"right_elbow":{"screen_x":306,"screen_y":281,"x":-23,"y":52,"z":658},"right_hand":null,"right_shoulder":{"screen_x":329,"screen_y":236,"x":17,"y":-5,"z":652}}},"options":["hallEffect_sensor P","neato SP","latency ","heartbeat ","bms ","analog P","pwm P","neopixel PC","servo P","create2 S","sabertooth2 S","sabertooth1 S","bts PPPP"],"pilot":{"cmd":{"arg":"","run":""},"power":{"L":0,"R":0},"time":0},"pilotHeartbeat":{"pilotHeartbeat":17},"run":{"options":["Squeak","bike horn"],"play":false,"sound":"Squeak"},"sensors":{"backend_battery":{"charging":false,"dischargingTime":"317.53 minutes","percent":"99.00%"},"heartbeats":99,"power":{"L":0,"R":0}}},"azure_layla2":{"active_experiment":"HelloWorld","authtest":"authtest","chat":[{"handle":"Caretaker","message":"sdf","time":1470342324628},{"handle":"Caretaker","message":"sdf","time":1470342426428},{"handle":"Caretaker","message":"sdf","time":1470342517139},{"handle":"Caretaker","message":"sdf","time":1470342517508},{"handle":"Caretaker","message":"sdf","time":1470342517752},{"handle":"Caretaker","message":"sdf","time":1470342517945},{"handle":"Caretaker","message":"sdf","time":1470342518127},{"handle":"Caretaker","message":"sdf","time":1470342518310},{"handle":"Caretaker","message":"sdf","time":1470342518526},{"handle":"Caretaker","message":"sdf","time":1470342518726},{"handle":"Caretaker","message":"123","time":1470342537370},{"handle":"Caretaker","message":"456","time":1470342539360},{"handle":"Pilot","message":"Welcome to azure layla chat!","time":1470436480017}],"config":{"configs":["pwm(13);","heartbeat();","bts(9,10,11,12);","bms();"],"counter":7},"experiments":{"HelloWorld":{"code":[{"code":"// JavaScript code\nlabel(djfsd)\nfds\nsfd\ns\nds\ns\n","name":"start","time":""}]},"No%20experiments%20found.":{"code":[{"code":"// JavaScript code\n","name":"start","time":""}]},"goofus":{"code":[{"code":"","name":"HelloWorld","time":0}]},"test":{"code":[{"code":"// JavaScript code\nlabel(\"In state\"+state)\ndelay(500)\nstate=blob","name":"groove","time":""},{"code":"// JavaScript code\nlabel(\"In state\"+state)\ndelay(500)\nstate=groove","name":"blob","time":""},{"code":"\n","name":"HelloWorld","time":""}]}},"frontendStatus":[{"heartbeats":1,"videobeats":0}],"frontend_status":{"1472843432000":{"heartbeats":161,"videobeats":62}},"gui":[{"active":false,"height":258,"minimized":false,"title":"Configure","width":663,"x":0,"y":10,"z":1},{"active":false,"height":395,"minimized":false,"title":"Drive","width":640,"x":0,"y":187,"z":2},{"active":false,"height":522,"minimized":false,"title":"Sensors","width":630,"x":182,"y":211,"z":3},{"active":false,"height":371,"minimized":true,"title":"Charts","width":868,"x":0,"y":264,"z":4},{"active":false,"height":617,"minimized":true,"title":"Code","width":867,"x":52,"y":108,"z":5},{"active":false,"height":719,"minimized":true,"title":"Map","width":670,"x":0,"y":0,"z":6},{"active":false,"height":100,"minimized":true,"title":"UI","width":265,"x":0,"y":318,"z":7},{"active":false,"height":118,"minimized":true,"title":"Sound","width":234,"x":244,"y":187,"z":8},{"active":false,"height":331,"minimized":true,"title":"Chat","width":445,"x":138,"y":171,"z":9},{"active":true,"height":428,"minimized":false,"title":"Video","width":635,"x":144,"y":102,"z":10}],"hah":"test","options":["ultrasonic_sensor PP","wheel_encoder PPC","encoder P","neato SP","latency ","heartbeat ","bms ","analog P","pwm P","neopixel PC","servo P","create2 S","sabertooth2 S","sabertooth1 S","bts PPPP"],"pilot":{"cmd":{"arg":"","run":""},"power":{"L":0,"R":0,"pwm":[]},"time":0},"pilotHeartbeat":{"pilotHeartbeat":17},"run":{"options":["Squeak","bike horn"],"play":false,"sound":""},"sensors":{"battery":{"charge":0,"state":0},"heartbeats":145,"power":{"L":0,"R":0,"pwm":[0]}}},"roomba":{"authtest":"authtest","chat":[{"handle":"Caretaker","message":"sdf","time":1470342547297},{"handle":"Caretaker","message":"sdf","time":1470342548651},{"handle":"Caretaker","message":"123","time":1470342549845},{"handle":"Pilot","message":"test","time":1470436490726}],"config":{"configs":["create2(X2);"],"counter":6},"frontendStatus":[{"heartbeats":76,"videobeats":0}],"frontend_status":{"1470436173000":{"heartbeats":7,"videobeats":0}},"gui":[{"active":false,"height":306,"minimized":true,"title":"Configure","width":653,"x":0,"y":154,"z":1},{"active":false,"height":414,"minimized":false,"title":"Drive","width":402,"x":0,"y":154,"z":2},{"active":false,"height":481,"minimized":false,"title":"Sensors","width":510,"x":388,"y":154,"z":3},{"active":false,"height":542,"minimized":true,"title":"Code","width":734,"x":423,"y":312,"z":4},{"active":false,"height":380,"minimized":false,"title":"Video","width":531,"x":562,"y":159,"z":5},{"active":false,"height":100,"minimized":true,"title":"UI","width":263,"x":0,"y":326,"z":6},{"active":false,"height":171,"minimized":false,"title":"Sound","width":396,"x":382,"y":246,"z":7},{"active":false,"height":403,"minimized":false,"title":"Map","width":518,"x":933,"y":163,"z":8},{"active":false,"height":534,"minimized":false,"title":"Charts","width":622,"x":166,"y":46,"z":9},{"active":true,"height":340,"minimized":false,"title":"Chat","width":440,"x":192,"y":114,"z":10}],"options":["ultrasonic_sensor PP","wheel_encoder PPC","encoder P","neato SP","latency ","heartbeat ","bms ","analog P","pwm P","neopixel PC","servo P","create2 S","sabertooth2 S","sabertooth1 S","bts PPPP"],"pilot":{"cmd":{"arg":"","run":""},"power":{"L":0,"R":0},"time":0},"run":{"options":["Squeak","bike horn"],"play":false,"sound":"Squeak"},"sensors":{"battery":{"charge":2132,"state":4,"temperature":35},"bumper":15,"buttons":0,"encoder":{"L":51161,"R":9006},"floor":[0,0,0,0],"heartbeats":247,"light":[0,0,0,3,0,0],"light_field":0,"location":{"angle":-131.84829060956409,"x":4.6854000247151211,"y":4.8372473422891833,"z":0},"mode":1,"power":{"L":100,"R":100}}},"shiny_layla":{"active_experiment":"HelloWorld","authtest":"authtest","chat":{"handle":"Pilot","message":"so a cobal, c++, and java programmer walk into a bar...","time":1467162770730},"config":{"configs":["bms();","bts(9,10,11,12);"],"counter":5},"experiments":{"HelloWorld":{"code":[{"code":"// JavaScript code\n","name":"start","time":""}]},"code":[{"code":"// JavaScript code\n","name":"start","time":""}],"test":{"code":[{"code":"// JavaScript code\n//test","name":"start","time":""}]},"test2":{"code":[{"code":"// JavaScript code\n//test2","name":"start","time":""}]}},"frontendStatus":[{"heartbeats":146,"videobeats":0}],"frontend_status":{"1470687813000":{"heartbeats":37,"videobeats":0},"1470687909000":{"heartbeats":7,"videobeats":0},"1470688099000":{"heartbeats":23,"videobeats":0}},"gui":[{"active":false,"height":322,"minimized":false,"title":"Configure","width":883,"x":168,"y":332,"z":1},{"active":false,"height":285,"minimized":false,"title":"Sensors","width":490,"x":280,"y":28,"z":2},{"active":false,"height":456,"minimized":false,"title":"Charts","width":344,"x":0,"y":6,"z":3},{"active":false,"height":390,"minimized":false,"title":"Code","width":511,"x":0,"y":0,"z":4},{"active":false,"height":445,"minimized":true,"title":"Map","width":448,"x":0,"y":0,"z":5},{"active":false,"height":290,"minimized":true,"title":"Video","width":452,"x":122,"y":51,"z":6},{"active":false,"height":100,"minimized":true,"title":"UI","width":269,"x":87,"y":268,"z":7},{"active":false,"height":118,"minimized":false,"title":"Sound","width":234,"x":63,"y":262,"z":8},{"active":false,"height":431,"minimized":true,"title":"Chat","width":389,"x":0,"y":0,"z":9},{"active":true,"height":420,"minimized":false,"title":"Drive","width":419,"x":201,"y":39,"z":10}],"options":["hallEffect_sensor P","neato SP","latency ","heartbeat ","bms ","analog P","pwm P","neopixel PC","servo P","create2 S","sabertooth2 S","sabertooth1 S","bts PPPP"],"pilot":{"cmd":{"arg":"","run":""},"power":{"L":0,"R":0},"time":0},"run":{"options":["Squeak","bike horn"],"play":false,"sound":""},"sensors":{"battery":{"charge":71,"state":16},"heartbeats":225,"power":{"L":0,"R":0}}},"stealth_layla":{"active_experiment":"HelloWorld","authtest":"authtest","chat":{"handle":"Pilot","message":"hello?","time":1467162686606},"config":{"configs":["bts(9,10,11,12);","bms();"],"counter":7},"experiments":{"HelloWorld":{"code":[{"code":"// JavaScript code\nvar ii=0;","name":"start","time":""}]}},"frontendStatus":[{"heartbeats":21,"videobeats":0}],"frontend_status":{},"gui":[{"active":false,"height":230,"minimized":true,"title":"Configure","width":653,"x":50,"y":51,"z":1},{"active":false,"height":398,"minimized":true,"title":"Code","width":770,"x":388,"y":122,"z":2},{"active":false,"height":719,"minimized":true,"title":"Map","width":670,"x":252,"y":33,"z":3},{"active":false,"height":101,"minimized":true,"title":"UI","width":264,"x":87,"y":207,"z":4},{"active":false,"height":289,"minimized":false,"title":"Sound","width":474,"x":36,"y":275,"z":5},{"active":false,"height":330,"minimized":true,"title":"Chat","width":426,"x":568,"y":152,"z":6},{"active":false,"height":607,"minimized":false,"title":"Charts","width":511,"x":791,"y":52,"z":7},{"active":false,"height":575,"minimized":false,"title":"Video","width":665,"x":367,"y":0,"z":8},{"active":false,"height":386,"minimized":false,"title":"Drive","width":426,"x":39,"y":86,"z":9},{"active":true,"height":323,"minimized":false,"title":"Sensors","width":545,"x":817,"y":149,"z":10}],"kinect":{"angle":-31.921036209310547,"flapping":false,"joints":{"head":{"screen_x":329,"screen_y":159,"x":15,"y":-101,"z":612},"left_elbow":null,"left_hand":null,"left_shoulder":{"screen_x":482,"screen_y":295,"x":305,"y":76,"z":680},"right_elbow":{"screen_x":455,"screen_y":398,"x":214,"y":190,"z":575},"right_hand":{"screen_x":130,"screen_y":286,"x":-272,"y":44,"z":502},"right_shoulder":{"screen_x":454,"screen_y":291,"x":227,"y":65,"z":617}}},"options":["ultrasonic_sensor PP","wheel_encoder PPC","encoder P","neato SP","latency ","heartbeat ","bms ","analog P","pwm P","neopixel PC","servo P","create2 S","sabertooth2 S","sabertooth1 S","bts PPPP"],"pilot":{"cmd":{"arg":"","run":""},"power":{"L":0,"R":0},"time":0},"run":{"options":["Squeak","bike horn"],"play":false,"sound":"Squeak"},"sensors":{"backend_battery":{"charging":true,"chargingTime":"0.00 minutes","percent":"100.00%"},"battery":{"charge":93,"state":24},"heartbeats":147,"power":{"L":0,"R":0}}},"test2":{"active_experiment":"HelloWorld","authtest":"authtest","config":{"configs":[],"counter":1},"experiments":{"HelloWorld":{"code":[{"code":"// JavaScript code","name":"start","time":""}]}},"frontend_status":{"1474777117000":{"heartbeats":4,"videobeats":0}},"gui":[{"active":false,"height":30,"minimized":true,"title":"Drive","width":67,"x":0,"y":0,"z":1},{"active":false,"height":30,"minimized":true,"title":"Sensors","width":510,"x":0,"y":0,"z":2},{"active":false,"height":84,"minimized":true,"title":"Charts","width":227,"x":0,"y":0,"z":3},{"active":false,"height":246,"minimized":true,"title":"Code","width":805,"x":0,"y":0,"z":4},{"active":false,"height":358,"minimized":true,"title":"Map","width":174,"x":0,"y":0,"z":5},{"active":false,"height":64,"minimized":true,"title":"Video","width":124,"x":0,"y":0,"z":6},{"active":false,"height":50,"minimized":true,"title":"UI","width":263,"x":0,"y":0,"z":7},{"active":false,"height":118,"minimized":true,"title":"Sound","width":231,"x":0,"y":0,"z":8},{"active":false,"height":138,"minimized":true,"title":"Chat","width":231,"x":0,"y":0,"z":9},{"active":true,"height":138,"minimized":false,"title":"Configure","width":670,"x":0,"y":0,"z":10}],"options":["ultrasonic_sensor PP","wheel_encoder PPC","encoder P","neato SP","latency ","heartbeat ","bms ","analog P","pwm P","neopixel PC","servo P","create2 S","sabertooth2 S","sabertooth1 S","bts PPPP"],"run":{"options":["Squeak","eagle","bike horn"],"play":false,"sound":"eagle"},"sensors":{"heartbeats":0}}}}}})";

//std::string test_db_str = "HelloWorld";
Json::Value database_m = JSON_deserialize(test_db_str);
std::string dummy_var;

//Replace all multiple slashes with a single slash (hacky...but it works...)
static std::string remove_double_slashes(std::string str) {
	size_t times=str.size()/2+1;
	for(size_t ii=0;ii<times;++ii)
		str=replace_all(str,"//","/");
	return str;
}

//Turn a path into a vector of strings.
//  "///test//hello//blah/" yields {"test","hello","blah"}.
std::vector<std::string> pathify(std::string path) {
	//Remove multiple,leading, and trailing slashes...
	path=remove_double_slashes(strip(path,"/"));

	//Finally tokenize the path...
	return split(path,"/");
}

bool get(layla_sim::get::Request &req, layla_sim::get::Response &res) {

	//Tokenize path.
	std::vector<std::string> paths(pathify(req.path));

	//JSON starts at root.
	const Json::Value* obj=&database_m;

	//Traverse paths.
	for(size_t ii=0;ii<paths.size();++ii)
	{
		//If object is an array, change to index instead of str.
		if(obj->isArray())
		{
			std::istringstream istr(paths[ii]);
			size_t index;
			bool was_int=((istr>>index)&&istr.eof());
			if(was_int)
			{
				obj=&((*obj)[(Json::ArrayIndex)index]);
				continue;
			}
		}

		//Path doesn't exist, or it's not an object, return null.
		if(!obj->isObject()||!obj->isMember(paths[ii])) {
			res.value = "";
			return true;
		}

		//Next path.
		obj=&((*obj)[paths[ii]]);
	}

	//Found object, return it.
	res.value = JSON_serialize(*obj);
	return true;
}

bool set(layla_sim::set::Request &req, layla_sim::set::Response &res) {
	// if(req.path == "/robots/2016/auto/gen/benchmark") {
	// 	dummy_var = req.value;
	// 	res.success = true;
	// }
	// return true;
	//Tokenize path.
	std::vector<std::string> paths(pathify(req.path));

	//JSON starts at root.
	Json::Value* obj=&database_m;
	Json::Value* par=&database_m;

	//Traverse paths.
	for(size_t ii=0;ii<paths.size();++ii)
	{
		//If object is an array, change to index instead of str.
		if(obj->isArray())
		{
			std::istringstream istr(paths[ii]);
			size_t index;
			bool was_int=((istr>>index)&&istr.eof());
			if(was_int)
			{
				obj=&((*obj)[(Json::ArrayIndex)index]);

				//Array value isn't an object...make it one.
				if(!obj->isObject()&&!obj->isArray())
					*obj=Json::objectValue;

				continue;
			}

			//Index wasn't an int...make the whole array an object...
			*obj=Json::objectValue;
		}

		//Path is not an object, make it one.
		if(!obj->isObject())
			*obj=Json::objectValue;

		//Path doesn't exist, make it.
		if(!obj->isMember(paths[ii]))
			((*obj)[paths[ii]])=Json::objectValue;

		//Next path.
		par=obj;
		obj=&((*obj)[paths[ii]]);
	}

	Json::Value val = JSON_deserialize(req.value);
	//Set value of path.
	if(val!=Json::nullValue)
		*obj=val;
	else if(par!=obj&&paths.size()>0)
		par->removeMember(paths[paths.size()-1]);
	else
		*obj=Json::nullValue;

	res.success = true;
	return true;

}

int main(int argc, char **argv) {
	ros::init(argc, argv, "tester_server");
	ros::NodeHandle n;

	ros::ServiceServer get_service = n.advertiseService("get", get);
	ros::ServiceServer set_service = n.advertiseService("set", set);
	ROS_INFO("Ready to service get and set requests.");
	ros::spin();

	return 0;
}
